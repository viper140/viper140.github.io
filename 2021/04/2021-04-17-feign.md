---
title: 'feign，远程调用新姿势'
date: 2021-04-17T01:00:00+08:00
lastmod: 2021-04-17T01:00:00+08:00
tags: ['rpc', 'http', 'spring cloud']
categories: ['开发']
author: '王峰'
---

slogan: Feign makes writing java http clients easier

<!--more-->

## 1 简介

<!-- slide vertical = true -->

- Feign is a Java to HTTP client binder inspired by Retrofit, JAXRS-2.0, and WebSocket.
- Feign's first goal was reducing the complexity of binding Denominator uniformly to HTTP APIs regardless of ReSTfulness.


- OpenFeign github: <https://github.com/OpenFeign>

<!-- slide -->

## 如何使用

<!-- slide vertical = true -->

### xxx

<!-- slide -->

## 带你避坑

<!-- slide vertical = true -->

### 关于超时

如果从 0 开始使用 feign client，一定会遇到请求超时，但可能是偶发的，

配置修改示例：（尤其 ReadTimeout，按照项目实际情况配置）

```yml
# feign client ribbon 配置
ribbon:
  # 默认1s -> 30s
  ReadTimeout: 30000
  # 默认1s -> 5s
  ConnectTimeout: 5000
```

### 集成测试失败

- 现象：运行 client 服务的集成测试，报错 `Load balancer does not have available server for client: international-flight-service`
- 原因：集成测试需要 mock 远程调用，所以需要关闭负载均衡
- 解决方案：集成测试需要使用固定地址，配置文件：

```yml
international-flight-service:
  # 固定地址，使 feign 的 LB 失效
  ribbon:
    listOfServers: localhost:${wiremock.port}
```

### FeignClient bean 重名问题

- 现象：启动 client 服务，报错 `The bean 'international-flight-service.FeignClientSpecification', defined in null, could not be registered. A bean with that name has already been defined in null and overriding is disabled`
- 原因：一个服务不允许多个 @FeignClient 的 value 的相同，因为 value 会作为 bean name，这是默认行为
- 解决方式：手动声明 contextId 作为 bean name

```java
@FeignClient(
  value = "international-flight-service",
  contextId = "intFlightSearchFlightsClient"
)
@RequestMapping({"/international-flight/v1/search"})
public interface IntFlightSearchFlightsClient {
}
```

### API 声明的返回值和实际返回值不一致

- 声明返回值：feign client interface 本应该和 controller 的返回值一致（甚至开始的时候我还打算让 controller implement feignClientInterface）。比如期望某 API 返回 String 类型
- 实际返回值：由于 filter 在返回值中做了些手脚，将结果包装了一层对象，并加上了错误码和错误信息等字段，实际返回值就成了 ResponseContainer\<String>
- 解决方案：
  - 方案一：有些同学本就反对在 filter 中做这种包装，如果移除这层逻辑，能解决根本问题，不过改动很大
  - 方案二：声明 feign client interface 的时候，让它和对应的 controller 返回值不同，并接受这种不一致的现状
    - 使用 ResponseContainer 包装返回结果
    - 使用 EmptyResponseContainer 替代 void 类型

### @RequestParam 注解和 springmvc 中的行为有稍许差异



 RequestParam.value() was empty on parameter 0
 

- value相同的多个feign client https://www.cnblogs.com/edda/p/13652483.html
- 完整配置 https://www.cnblogs.com/WaterGe/p/11687118.html

Method has too many Body parameters
feign中你可以有多个@RequestParam，但只能有不超过一个@RequestBody


 Error creating bean with name 'com.tehang.intflight.common.api.search.IntFlightSearchFlightsClient': FactoryBean threw exception on object creation; nested exception is java.lang.IllegalStateException: No fallback instance of type class com.tehang.intflight.common.api.search.IntFlightSearchFlightsClientFallBack found for feign client international-flight-service

@ComponentScan(basePackages = "com.tehang.intflight.common.*")

  Ambiguous mapping. Cannot map 'com.tehang.intflight.common.api.search.IntFlightSearchFlightsClient' method 


  异常如果从 CommonExceptionHandler 逃逸出来，就会触发熔断

  直接受益
  间接受益：分布式事务